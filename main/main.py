# -*- coding: utf-8 -*-
"""–¢–ò–ù–¨–ö–û–§.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1S3jrDm9OGY9Ki5DjBqAkqv9LVgMJ16oK

–≠—Ç–æ—Ç –±–ª–æ–∫ ‚Äî —Ñ—É–Ω–¥–∞–º–µ–Ω—Ç –≤—Å–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞. –ó–¥–µ—Å—å —Å–æ–±—Ä–∞–Ω—ã –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç–µ–ª—å–Ω—ã–µ —à–∞–≥–∏.

1.   –ò–º–ø–æ—Ä—Ç—ã: –ú—ã –ø–æ–¥–∫–ª—é—á–∞–µ–º –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (pandas, matplotlib, seaborn –∏ –¥—Ä.).
2.   –ù–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –° –ø–æ–º–æ—â—å—é dataclass Config –º—ã –∑–∞–¥–∞–µ–º –≤—Å–µ –∫–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ: –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º, —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏, –Ω–∞–∑–≤–∞–Ω–∏—è –≤—ã—Ö–æ–¥–Ω—ã—Ö –ø–∞–ø–æ–∫. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –∫–æ–¥ –≥–∏–±–∫–∏–º ‚Äî —á—Ç–æ–±—ã –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø–æ–¥ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∑–¥–µ—Å—å.
3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ä–µ–¥—ã: –ú—ã —Å–æ–∑–¥–∞–µ–º –ø–∞–ø–∫–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å –≥—Ä–∞—Ñ–∏–∫–æ–≤, —á—Ç–æ–±—ã –æ–Ω–∏ –≤—ã–≥–ª—è–¥–µ–ª–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ –≤–æ –≤—Å–µ–º –ø—Ä–æ–µ–∫—Ç–µ.
"""

#Imports
from __future__ import annotations
import os, sys, io, json, base64, textwrap, math, warnings, statistics
from pathlib import Path
from dataclasses import dataclass
from typing import Optional, Dict, List, Tuple
from operator import attrgetter

import numpy as np
import pandas as pd
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.dates as mdates
import nbformat as nbf
from nbformat.v4 import new_notebook, new_code_cell, new_markdown_cell

try:
    import seaborn as sns
    _HAS_SEABORN = True
except Exception:
    _HAS_SEABORN = False

#Configuration
@dataclass
class Config:
    csv_path: str = "/content/drive/MyDrive/Colab Notebooks/dano_dataset_travel.csv"   # –ø—É—Ç—å –∫ –¥–∞—Ç–∞—Å–µ—Ç—É
    sep: str = ";"
    encoding: str = "utf-8"
    out_dir: Path = Path("tbank_travel_eda")
    figs_dpi: int = 170
    max_sample_hist: int = 250_000
    ipynb_path: Path = Path("TBank_Travel_EDA.ipynb")
    html_path: Path = Path("TBank_Travel_EDA_Report.html")
    random_state: int = 42

CFG = Config()

#Environment Setup
np.random.seed(CFG.random_state)

# –°–æ–∑–¥–∞–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
CFG.out_dir.mkdir(parents=True, exist_ok=True)
(CFG.out_dir / "png").mkdir(exist_ok=True)
(CFG.out_dir / "svg").mkdir(exist_ok=True)
(CFG.out_dir / "csv").mkdir(exist_ok=True)

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ matplotlib
matplotlib.rcParams.update({
    "figure.figsize": (9.6, 5.0),
    "figure.dpi": 120,
    "axes.grid": True,
    "grid.alpha": 0.25,
    "axes.titleweight": "bold",
    "axes.titlesize": 13,
    "axes.labelsize": 11,
    "xtick.labelsize": 10,
    "ytick.labelsize": 10,
    "font.family": "DejaVu Sans",
})

if _HAS_SEABORN:
    sns.set_theme(context="notebook", style="ticks")

"""–ó–¥–µ—Å—å –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –≤—Å–µ –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ –ø—Ä–æ–µ–∫—Ç–µ. –≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–º–æ–≥–∞–µ—Ç –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞ (Don't Repeat Yourself) –∏ –¥–µ–ª–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –±–æ–ª–µ–µ —á–∏—Ç–∞–µ–º—ã–º.
–í —ç—Ç–æ—Ç –±–ª–æ–∫ –≤—Ö–æ–¥—è—Ç —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è:

*   –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–∏—Å–µ–ª, –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –∏ –¥–∞—Ç.
*   –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ –≤ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ä–º–∞—Ç–∞—Ö (PNG, SVG).
*   –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –¥–ª—è –≤—Å—Ç—Ä–∞–∏–≤–∞–Ω–∏—è –≤ HTML-–æ—Ç—á–µ—Ç.
*   –ü–æ–¥–±–æ—Ä–∞ –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–≥–æ —á–∏—Å–ª–∞ –∫–æ—Ä–∑–∏–Ω –¥–ª—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º (nice_bins).

*   –ü—Ä–∏–≤–µ–¥–µ–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ –∫ —á–∏—Å–ª–æ–≤–æ–º—É —Ç–∏–ø—É —Å –æ—á–∏—Å—Ç–∫–æ–π –æ—Ç "–º—É—Å–æ—Ä–∞".

"""

def _fmt_int(n: Optional[float]) -> str:
    if n is None or (isinstance(n, float) and (np.isnan(n) or np.isinf(n))):
        return "‚Äî"
    return f"{int(n):,}".replace(",", " ")

def _fmt_float(n: Optional[float], p: int = 1) -> str:
    if n is None or (isinstance(n, float) and (np.isnan(n) or np.isinf(n))):
        return "‚Äî"
    return f"{n:.{p}f}"

def _fmt_pct(x: Optional[float], p: int = 1) -> str:
    if x is None or (isinstance(x, float) and (np.isnan(x) or np.isinf(x))):
        return "‚Äî"
    return f"{x*100:.{p}f}%"

def savefig(fig: matplotlib.figure.Figure, name: str, tight: bool = True) -> Tuple[Path, Path]:
    png_path = CFG.out_dir / "png" / f"{name}.png"
    svg_path = CFG.out_dir / "svg" / f"{name}.svg"
    if tight:
        fig.tight_layout()
    fig.savefig(png_path, dpi=CFG.figs_dpi, bbox_inches="tight")
    fig.savefig(svg_path, bbox_inches="tight")
    print(f"[saved] {png_path.name} / {svg_path.name}")
    return png_path, svg_path

def img_to_base64(path: Path) -> str:
    with open(path, "rb") as f:
        return base64.b64encode(f.read()).decode("ascii")

def coerce_numeric(series: pd.Series) -> pd.Series:
    return pd.to_numeric(
        series.astype(str).str.replace(" ", "", regex=False)
              .str.replace("\xa0","", regex=False)
              .str.replace(",", ".", regex=False),
        errors="coerce"
    )

def nice_bins(series: pd.Series, target_bins=40) -> int:
    n = series.dropna().shape[0]
    if n <= 0:
        return 10
    try:
        iqr = np.subtract(*np.percentile(series.dropna(), [75, 25]))
        h = 2 * iqr * (n ** (-1/3)) if iqr > 0 else None
        if h:
            bins = int((series.max() - series.min()) / max(h, 1e-9))
            return max(10, min(100, bins))
    except Exception:
        pass
    return min(80, max(15, int(np.sqrt(n))))

def annotate_bars(ax, fmt: str = "{:.1f}%", yshift: float = 0.01):
    for p in ax.patches:
        height = p.get_height()
        ax.annotate(fmt.format(height), (p.get_x() + p.get_width()/2., height),
                    ha='center', va='bottom', xytext=(0, ax.get_ylim()[1]*yshift),
                    textcoords='data', fontsize=9)

def ecdf(series: pd.Series) -> Tuple[np.ndarray, np.ndarray]:
    x = np.sort(series.dropna().values)
    y = np.arange(1, len(x)+1) / len(x) if len(x) else np.array([])
    return x, y

def qscore(series: pd.Series, q: int = 5, reverse: bool = False) -> pd.Series:
    ranks = series.rank(method="first", na_option="bottom")
    try:
        bins = pd.qcut(ranks, q=q, labels=False, duplicates="drop") + 1
    except Exception:
        bins = pd.Series(1, index=series.index, dtype="float64")
    if reverse:
        bins = q + 1 - bins
    return bins.fillna(0).astype(int)

"""  –≠—Ç–æ –∫–ª—é—á–µ–≤–æ–π —ç—Ç–∞–ø –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –í—Å—è —Ä–∞–±–æ—Ç–∞ —Å "—Å—ã—Ä—ã–º" –¥–∞—Ç–∞—Å–µ—Ç–æ–º –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∑–¥–µ—Å—å. –ë–ª–æ–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ç—Ä–∏ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏:

1. –ó–∞–≥—Ä—É–∑–∫–∞: –ß—Ç–µ–Ω–∏–µ CSV-—Ñ–∞–π–ª–∞ –≤ DataFrame —Å –ø–æ–º–æ—â—å—é pandas.read_csv.
2. –û—á–∏—Å—Ç–∫–∞ –∏ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –∫–æ–ª–æ–Ω–æ–∫ —Å –¥–∞—Ç–∞–º–∏ –≤ —Ñ–æ—Ä–º–∞—Ç datetime, —á–∏—Å–ª–æ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ ‚Äî –≤ numeric (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫ –∏ —Ñ–æ—Ä–º–∞—Ç–æ–≤), –∞ —Ñ–ª–∞–≥–æ–≤ ‚Äî –≤ –±—É–ª–µ–≤ (True/False) —Ç–∏–ø.
3. –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–∑–Ω–∞–∫–æ–≤ (Feature Engineering): –†–∞—Å—á–µ—Ç –Ω–æ–≤—ã—Ö, –ø–æ–ª–µ–∑–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–ª–æ–Ω–æ–∫, —Ç–∞–∫–∏—Ö –∫–∞–∫ is_success (—É—Å–ø–µ—à–Ω—ã–π –ª–∏ –∑–∞–∫–∞–∑), lead_time_days (–≤—Ä–µ–º—è –¥–æ –Ω–∞—á–∞–ª–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è) –∏ stay_nights (–¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è).
"""

print(f"[load] {CFG.csv_path}")
df = pd.read_csv(CFG.csv_path, sep=CFG.sep, encoding=CFG.encoding, low_memory=False)

DATE_COLS = [
    "party_first_order_dt","party_first_order_type_dt","free_cancel_booking_dttm",
    "created_dttm","cancel_dttm","book_start_dttm","local_book_start_dttm","book_end_dttm",
    "last_sms_dt","last_email_send_dt","last_session_dttm"
]
for c in DATE_COLS:
    if c in df.columns:
        df[c] = pd.to_datetime(df[c], errors="coerce")

NUM_COLS = ["promo_code_discount_amt","loyalty_accrual_rub_amt",
            "nominal_price_eur_amt","nominal_price_rub_amt","monthly_income_amt"]
for c in NUM_COLS:
    if c in df.columns:
        df[c] = coerce_numeric(df[c])

FLAG_COLS = [c for c in df.columns if c.endswith("_flg")]
for c in FLAG_COLS:
    df[c] = pd.to_numeric(df[c].astype(str).str.replace(",", ".", regex=False), errors="coerce")
    df[c] = (df[c].fillna(0) > 0)

df["order_type"] = df.get("order_type_cd", pd.Series(index=df.index)).map({"AIR":"–ê–≤–∏–∞–±–∏–ª–µ—Ç—ã","HOT":"–û—Ç–µ–ª–∏"}).fillna(df.get("order_type_cd"))
df["is_success"] = df.get("order_status_cd","").eq("SUC")
df["order_date"]  = df["created_dttm"].dt.date
df["order_month"] = df["created_dttm"].dt.to_period("M").astype(str)
df["dow"]  = df["created_dttm"].dt.dayofweek
df["hour"] = df["created_dttm"].dt.hour
df["lead_time_days"] = (df["book_start_dttm"] - df["created_dttm"]).dt.days
df["stay_nights"]    = (df["book_end_dttm"]   - df["book_start_dttm"]).dt.days
df.loc[df.get("order_type_cd")!="HOT", "stay_nights"] = np.nan

def lead_bucket(x: float) -> str:
    if pd.isna(x): return "NA"
    if x <= 0: return "0d"
    if x <= 3: return "1-3d"
    if x <= 7: return "4-7d"
    if x <= 14: return "8-14d"
    if x <= 30: return "15-30d"
    return "31+d"
df["lead_bucket"] = df["lead_time_days"].map(lead_bucket)

if "age" in df.columns:
    df["age"] = coerce_numeric(df["age"])
if "children_cnt" in df.columns:
    df["children_cnt"] = coerce_numeric(df["children_cnt"])

"""–°–µ—Ä–¥—Ü–µ –Ω–∞—à–µ–≥–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è. –ó–¥–µ—Å—å –º—ã –ø—Ä–æ–≤–æ–¥–∏–º —Ä–∞–∑–≤–µ–¥–æ—á–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (EDA), —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–µ –∏–Ω—Å–∞–π—Ç—ã, –∑–∞–∫–æ–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç–∏ –∏ –∞–Ω–æ–º–∞–ª–∏–∏.
–ë–ª–æ–∫ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è:
1. –û–±–∑–æ—Ä –¥–∞–Ω–Ω—ã—Ö: –í—ã–≤–æ–¥ –æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Ä–∞–∑–º–µ—Ä–µ –¥–∞—Ç–∞—Å–µ—Ç–∞, –≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø–µ—Ä–∏–æ–¥–µ –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–æ–≤.
2. –†–∞—Å—á–µ—Ç —Å–≤–æ–¥–Ω—ã—Ö —Ç–∞–±–ª–∏—Ü: –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–µ—Ç—Ä–∏–∫ (—Å—Ä–µ–¥–Ω–∏–π —á–µ–∫, –∫–æ–Ω–≤–µ—Ä—Å–∏—è –ø–æ —Ç–∏–ø–∞–º) –∏ –∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ CSV-—Ñ–∞–π–ª—ã.
3. –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –≥—Ä–∞—Ñ–∏–∫–æ–≤: –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞–≥–ª—è–¥–Ω–æ–≥–æ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è. –ú—ã —Å—Ç—Ä–æ–∏–º –¥–∏–Ω–∞–º–∏–∫—É –∑–∞–∫–∞–∑–æ–≤, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ü–µ–Ω, –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã –∏ —Ç–µ–ø–ª–æ–≤—ã–µ –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–æ–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π.
"""

rows, cols = df.shape
period = (str(df["created_dttm"].min())[:10], str(df["created_dttm"].max())[:10])
by_type = df["order_type"].value_counts(dropna=False)

print(f"[shape] {rows:,} rows x {cols} cols".replace(",", " "))
print(f"[period] {period[0]} ‚Ä¶ {period[1]}")
print("[types]\n", by_type)

summary_by_type = df.groupby("order_type", dropna=False).agg(
    orders=("order_rk","count"),
    success_rate=("is_success","mean"),
    avg_price_rub=("nominal_price_rub_amt","mean"),
    median_price_rub=("nominal_price_rub_amt","median"),
    p90_price_rub=("nominal_price_rub_amt", lambda s: np.nanpercentile(s.dropna(), 90) if s.notna().any() else np.nan)
).reset_index().sort_values("orders", ascending=False)
summary_by_type.to_csv(CFG.out_dir/"csv"/"summary_by_type.csv", index=False)
print("[saved] summary_by_type.csv")

monthly_type = (df.groupby(["order_month","order_type"]).size()
                  .reset_index(name="orders")
                  .sort_values(["order_month","order_type"]))
monthly_type.to_csv(CFG.out_dir/"csv"/"monthly_by_type.csv", index=False)
print("[saved] monthly_by_type.csv")

lead_summary = (df.groupby(["order_type","lead_bucket"])
                  .agg(orders=("order_rk","count"),
                       success_rate=("is_success","mean"),
                       avg_price=("nominal_price_rub_amt","mean"))
                  .reset_index()
                  .sort_values(["order_type","lead_bucket"]))
lead_summary.to_csv(CFG.out_dir/"csv"/"lead_summary.csv", index=False)
print("[saved] lead_summary.csv")

fig1, ax1 = plt.subplots()
pivot = (df.groupby(["order_month","order_type"])["order_rk"].count()
           .unstack(fill_value=0)
           .sort_index())
pivot.plot(ax=ax1, marker="o")
ax1.set_title("–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º (–ø–æ —Ç–∏–ø–∞–º)")
ax1.set_xlabel("–ú–µ—Å—è—Ü"); ax1.set_ylabel("–ß–∏—Å–ª–æ –∑–∞–∫–∞–∑–æ–≤")
ax1.tick_params(axis='x', rotation=45)
for col in pivot.columns:
    y = pivot[col].iloc[-1]
    ax1.annotate(f"{_fmt_int(y)}", xy=(len(pivot)-1, y), xytext=(5, 5), textcoords="offset points", fontsize=9)
p1, s1 = savefig(fig1, "orders_by_month")

fig2, ax2 = plt.subplots()
sr = (df.groupby("order_type")["is_success"].mean().sort_values(ascending=False) * 100)
sr.plot(kind="bar", ax=ax2)
ax2.set_title("–î–æ–ª—è —É—Å–ø–µ—à–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (SUC), %")
ax2.set_xlabel("–¢–∏–ø –∑–∞–∫–∞–∑–∞"); ax2.set_ylabel("% —É—Å–ø–µ—à–Ω—ã—Ö")
for i, v in enumerate(sr.values):
    ax2.text(i, v + max(1, sr.max()*0.02), f"{v:.1f}%", ha="center", va="bottom", fontsize=10)
p2, s2 = savefig(fig2, "success_rate_by_type")

fig3, ax3 = plt.subplots(figsize=(9.6, 5.5))
if _HAS_SEABORN:
    sns.violinplot(data=df, x="order_type", y="nominal_price_rub_amt", cut=0, inner="quartile", ax=ax3)
    ax3.set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ü–µ–Ω—ã –∑–∞–∫–∞–∑–∞, ‚ÇΩ (–≤–∏–æ–ª–∏–Ω—ã —Å –∫–≤–∞—Ä—Ç–∏–ª—è–º–∏)")
else:
    df.boxplot(column="nominal_price_rub_amt", by="order_type", ax=ax3)
    ax3.set_title("–¶–µ–Ω–∞ –∑–∞–∫–∞–∑–∞, ‚ÇΩ (–±–æ–∫—Å–ø–ª–æ—Ç)")
    plt.suptitle("")
ax3.set_xlabel("–¢–∏–ø –∑–∞–∫–∞–∑–∞"); ax3.set_ylabel("–¶–µ–Ω–∞, ‚ÇΩ")
p3, s3 = savefig(fig3, "price_distribution")

lead = df["lead_time_days"].dropna().clip(lower=-5, upper=60)
if lead.shape[0] > CFG.max_sample_hist:
    lead = lead.sample(CFG.max_sample_hist, random_state=CFG.random_state)
fig4, ax4 = plt.subplots()
ax4.hist(lead, bins=nice_bins(lead), edgecolor="white")
ax4.set_title("–õ–∏–¥-—Ç–∞–π–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–Ω–µ–π)")
ax4.set_xlabel("–î–Ω–µ–π –æ—Ç —Å–æ–∑–¥–∞–Ω–∏—è –¥–æ –Ω–∞—á–∞–ª–∞ –ø–æ–µ–∑–¥–∫–∏"); ax4.set_ylabel("–ß–∞—Å—Ç–æ—Ç–∞")
for q in [5, 25, 50, 75, 95]:
    v = np.percentile(lead, q)
    ax4.axvline(v, color="tab:red", lw=1, ls="--")
    ax4.text(v, ax4.get_ylim()[1]*0.95, f"P{q}={v:.0f}", rotation=90, ha="right", va="top", color="tab:red", fontsize=9)
p4, s4 = savefig(fig4, "lead_time_hist")

stay = df.loc[df.get("order_type_cd")=="HOT", "stay_nights"].dropna().clip(lower=0, upper=30)
fig5, ax5 = plt.subplots()
ax5.hist(stay, bins=nice_bins(stay), edgecolor="white")
ax5.set_title("–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è (–æ—Ç–µ–ª–∏)")
ax5.set_xlabel("–ù–æ—á–µ–π"); ax5.set_ylabel("–ß–∞—Å—Ç–æ—Ç–∞")
for q in [50, 90]:
    v = np.percentile(stay, q) if stay.shape[0] else np.nan
    if pd.notna(v):
        ax5.axvline(v, color="tab:red", lw=1, ls="--")
        ax5.text(v, ax5.get_ylim()[1]*0.95, f"P{q}={v:.0f}", rotation=90, ha="right", va="top", color="tab:red", fontsize=9)
p5, s5 = savefig(fig5, "stay_nights_hist")

lead_pivot = (df.groupby(["order_type","lead_bucket"])["is_success"].mean().unstack(fill_value=np.nan))
fig6, ax6 = plt.subplots()
(lead_pivot*100).T.plot(kind="bar", ax=ax6)
ax6.set_title("SUC-rate (%) –ø–æ –∫–æ—Ä–∑–∏–Ω–∞–º lead-time")
ax6.set_xlabel("–ö–æ—Ä–∑–∏–Ω–∞ lead-time"); ax6.set_ylabel("% SUC"); ax6.legend(title="–¢–∏–ø –∑–∞–∫–∞–∑–∞")
plt.xticks(rotation=0)
p6, s6 = savefig(fig6, "success_by_lead_bucket")

heat = (df.groupby(["order_month","order_type"])["is_success"].mean().unstack())
fig7, ax7 = plt.subplots(figsize=(10, 5))
if _HAS_SEABORN:
    sns.heatmap(heat.T*100, annot=True, fmt=".1f", cmap="YlGnBu", cbar_kws={"label":"SUC, %"}, ax=ax7)
else:
    im = ax7.imshow((heat.T*100).fillna(0).values, aspect="auto", cmap="viridis")
    ax7.set_yticks(range(len(heat.columns))); ax7.set_yticklabels(heat.columns)
    ax7.set_xticks(range(len(heat.index)));   ax7.set_xticklabels(heat.index, rotation=45)
    fig7.colorbar(im, ax=ax7, label="SUC, %")
ax7.set_title("SUC-rate –ø–æ –º–µ—Å—è—Ü–∞–º –∏ —Ç–∏–ø–∞–º (—Ç–µ–ø–ª–æ–∫–∞—Ä—Ç–∞)")
p7, s7 = savefig(fig7, "heatmap_success_month_type")

fig8, ax8 = plt.subplots()
for t, sub in df.groupby("order_type"):
    x, y = ecdf(sub["nominal_price_rub_amt"].dropna().clip(lower=0, upper=np.nanpercentile(df["nominal_price_rub_amt"].dropna(), 99)))
    if len(x): ax8.plot(x, y, label=t)
ax8.set_title("ECDF —Ü–µ–Ω—ã (–Ω–∞–∫–æ–ø. —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ)")
ax8.set_xlabel("–¶–µ–Ω–∞, ‚ÇΩ"); ax8.set_ylabel("–î–æ–ª—è ‚â§ x"); ax8.legend()
p8, s8 = savefig(fig8, "price_ecdf")

tmp = df[["nominal_price_rub_amt","is_success","order_type"]].dropna()
tmp["price_decile"] = pd.qcut(tmp["nominal_price_rub_amt"], q=10, duplicates="drop")
dec = (tmp.groupby(["order_type","price_decile"])["is_success"].mean().reset_index())
def qmid(qstr: str) -> float:
    try: return (float(qstr.strip("()[]").split(",")[0]) + float(qstr.strip("()[]").split(",")[1])) / 2
    except: return 0.0
dec["mid"] = dec["price_decile"].astype(str).map(qmid)
fig9, ax9 = plt.subplots()
for t, sub in dec.sort_values("mid").groupby("order_type"):
    ax9.plot(sub["mid"], sub["is_success"]*100, marker="o", label=t)
ax9.set_title("SUC-rate vs —Ü–µ–Ω–∞ (–¥–µ—Ü–∏–ª–∏)"); ax9.set_xlabel("–°–µ—Ä–µ–¥–∏–Ω–∞ –¥–µ—Ü–∏–ª–∏ —Ü–µ–Ω—ã, ‚ÇΩ")
ax9.set_ylabel("SUC, %"); ax9.legend()
p9, s9 = savefig(fig9, "success_vs_price_deciles")

wh = (df.groupby(["dow","hour"])["order_rk"].count().unstack(fill_value=0))
fig10, ax10 = plt.subplots(figsize=(10, 5))
if _HAS_SEABORN:
    sns.heatmap(wh, cmap="Blues", ax=ax10, cbar_kws={"label":"# –∑–∞–∫–∞–∑–æ–≤"})
else:
    im = ax10.imshow(wh.values, aspect="auto", cmap="Blues")
    fig10.colorbar(im, ax=ax10, label="# –∑–∞–∫–∞–∑–æ–≤")
    ax10.set_xticks(range(len(wh.columns))); ax10.set_xticklabels(wh.columns)
    ax10.set_yticks(range(len(wh.index)));   ax10.set_yticklabels(wh.index)
ax10.set_title("–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∑–∞–∫–∞–∑–æ–≤ –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏ –∏ —á–∞—Å—É")
ax10.set_xlabel("–ß–∞—Å"); ax10.set_ylabel("–î–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (0=–ü–Ω)")
p10, s10 = savefig(fig10, "orders_by_dow_hour")

"""–í —ç—Ç–æ–º –±–ª–æ–∫–µ —Å–æ–±—Ä–∞–Ω—ã –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ –∏ –≥–ª—É–±–æ–∫–∏–µ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥–∏–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –¥–∞—é—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø–æ–≤–µ–¥–µ–Ω–∏—è. –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ EDA, –∑–¥–µ—Å—å –º—ã —Å–º–æ—Ç—Ä–∏–º –Ω–∞ –¥–∞–Ω–Ω—ã–µ –ø–æ–¥ –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–º —É–≥–ª–æ–º:
1. –ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑: –ò–∑—É—á–∞–µ–º —É–¥–µ—Ä–∂–∞–Ω–∏–µ (Retention) –∏ –ø–æ–∂–∏–∑–Ω–µ–Ω–Ω—É—é —Ü–µ–Ω–Ω–æ—Å—Ç—å (LTV) –∫–ª–∏–µ–Ω—Ç–æ–≤.
2. RFM-—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è: –î–µ–ª–∏–º –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –≥—Ä—É–ø–ø—ã –ø–æ –¥–∞–≤–Ω–æ—Å—Ç–∏, —á–∞—Å—Ç–æ—Ç–µ –∏ —Å—É–º–º–µ –ø–æ–∫—É–ø–æ–∫, —á—Ç–æ–±—ã –≤—ã—è–≤–∏—Ç—å —Å–∞–º—ã—Ö —Ü–µ–Ω–Ω—ã—Ö.
3. –ê–Ω–∞–ª–∏–∑ –∫—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂: –í—ã—è—Å–Ω—è–µ–º, –∫–∞–∫ —á–∞—Å—Ç–æ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ–∫—É–ø–∞—é—Ç –∏ –∞–≤–∏–∞–±–∏–ª–µ—Ç—ã, –∏ –æ—Ç–µ–ª–∏.
–ú–µ—Ç—Ä–∏–∫–∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏: –°—á–∏—Ç–∞–µ–º DAU/WAU/MAU –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏.
"""

assert "client_rk" in df.columns, "–ù—É–∂–µ–Ω client_rk –¥–ª—è –∫–æ–≥–æ—Ä—Ç."
clients = df[["client_rk","created_dttm","nominal_price_rub_amt"]].copy()
clients["order_month_p"] = clients["created_dttm"].dt.to_period("M")
clients["first_month"] = clients.groupby("client_rk")["order_month_p"].transform("min")

def period_diff_months(a: pd.Series, b: pd.Series) -> pd.Series:
    out = pd.Series(pd.NA, index=a.index, dtype="Int64")
    mask = a.notna() & b.notna()
    out.loc[mask] = (a[mask].astype("int") - b[mask].astype("int")).astype("int")
    return out
clients["month_idx"] = period_diff_months(clients["order_month_p"], clients["first_month"])

cln = clients.dropna(subset=["month_idx"]).copy()
cln["month_idx"] = cln["month_idx"].astype("int")

cohort_sizes = cln.drop_duplicates(["client_rk","first_month"]).groupby("first_month")["client_rk"].nunique()
active = cln.drop_duplicates(["client_rk","first_month","order_month_p"]).groupby(["first_month","month_idx"])["client_rk"].nunique().unstack(fill_value=0)
retention = active.div(cohort_sizes, axis=0).sort_index()
retention_13 = retention.iloc[:, :min(13, retention.shape[1])]

figR, axR = plt.subplots(figsize=(10.5, 5.5))
im = axR.imshow((retention_13*100).fillna(0).values, aspect="auto", cmap="YlGnBu", vmin=0, vmax=100)
axR.set_title("Retention –∫–æ–≥–æ—Ä—Ç (%) ‚Äî –º–µ—Å—è—Ü 0..12 –æ—Ç –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞"); axR.set_xlabel("–ú–µ—Å—è—Ü —Å –º–æ–º–µ–Ω—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ –∫–æ–≥–æ—Ä—Ç—ã"); axR.set_ylabel("–ö–æ–≥–æ—Ä—Ç–∞ (–º–µ—Å—è—Ü –ø–µ—Ä–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞)")
axR.set_xticks(range(retention_13.shape[1])); axR.set_xticklabels(list(range(retention_13.shape[1])))
axR.set_yticks(range(len(retention_13.index))); axR.set_yticklabels([str(p) for p in retention_13.index.astype(str)])
figR.colorbar(im, ax=axR, label="Retention, %")
pR, sR = savefig(figR, "cohort_retention")

rev = cln.groupby(["first_month","month_idx"])["nominal_price_rub_amt"].sum().unstack(fill_value=0).sort_index()
ltv = rev.cumsum(axis=1).div(cohort_sizes, axis=0)
avg_ltv = ltv.mean(axis=0)
figL, axL = plt.subplots(figsize=(9.6, 5.0))
for i, (cohort, row) in enumerate(ltv.iterrows()):
    if i % max(1, len(ltv)//10) == 0:
        axL.plot(row.index, row.values, alpha=0.25, lw=1)
axL.plot(avg_ltv.index, avg_ltv.values, color="tab:red", lw=2.5, label="–°—Ä–µ–¥–Ω—è—è LTV")
axL.set_title("LTV-–∫—Ä–∏–≤–∞—è: –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ä—É–±.)"); axL.set_xlabel("–ú–µ—Å—è—Ü —Å –º–æ–º–µ–Ω—Ç–∞ —Å—Ç–∞—Ä—Ç–∞ –∫–æ–≥–æ—Ä—Ç—ã"); axL.set_ylabel("–†—É–±–ª–∏ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"); axL.legend()
pL, sL = savefig(figL, "cohort_ltv")

#RFM Segmentation
required_cols = {"client_rk", "order_rk", "created_dttm", "nominal_price_rub_amt"}
if not (required_cols - set(df.columns)):
    rfm = (df.groupby("client_rk", dropna=False)
             .agg(last_order=("created_dttm", "max"), freq=("order_rk", "count"), monetary=("nominal_price_rub_amt", "sum"))
             .reset_index())
    rfm["recency_days"] = (df["created_dttm"].max() - rfm["last_order"]).dt.days
    rfm["R"] = qscore(rfm["recency_days"], q=5, reverse=True)
    rfm["F"] = qscore(rfm["freq"], q=5, reverse=False)
    rfm["M"] = qscore(rfm["monetary"], q=5, reverse=False)
    rfm["RFM_Score"] = rfm["R"].astype(str) + rfm["F"].astype(str) + rfm["M"].astype(str)
    rfm["AOV"] = rfm["monetary"] / rfm["freq"].replace(0, np.nan)
    rfm.to_csv(CFG.out_dir / "csv" / "rfm_table.csv", index=False)
    print("[saved] rfm_table.csv")

    top_rfm = rfm["RFM_Score"].value_counts().head(20).sort_values()
    figRFM1, axRFM1 = plt.subplots(figsize=(10, 6))
    axRFM1.barh(top_rfm.index, top_rfm.values); axRFM1.set_title("–¢–æ–ø RFM-—Å–µ–≥–º–µ–Ω—Ç–æ–≤ –ø–æ —á–∏—Å–ª—É –∫–ª–∏–µ–Ω—Ç–æ–≤"); axRFM1.set_xlabel("–ö–ª–∏–µ–Ω—Ç–æ–≤")
    for y, v in enumerate(top_rfm.values): axRFM1.text(v, y, f" {_fmt_int(v)}", va="center")
    pRFM1, sRFM1 = savefig(figRFM1, "rfm_top_segments")

    figRFM2, axRFM2 = plt.subplots(figsize=(9.5, 6))
    sizes = np.sqrt(rfm["AOV"].fillna(0).clip(lower=0)) * 6 + 10
    sc = axRFM2.scatter(rfm["freq"], rfm["monetary"], c=rfm["R"], cmap="viridis", s=sizes, alpha=0.6, linewidths=0)
    axRFM2.set_title("RFM: Frequency vs Monetary (—Ü–≤–µ—Ç=R, —Ä–∞–∑–º–µ—Ä‚âà‚àöAOV)"); axRFM2.set_xlabel("Frequency (—á–∏—Å–ª–æ –∑–∞–∫–∞–∑–æ–≤)"); axRFM2.set_ylabel("Monetary (—Å—É–º–º–∞—Ä–Ω–∞—è –≤—ã—Ä—É—á–∫–∞, ‚ÇΩ)")
    cb = plt.colorbar(sc, ax=axRFM2); cb.set_label("Recency score (R)")
    pRFM2, sRFM2 = savefig(figRFM2, "rfm_scatter")

#Cross-Sell
client_types = df.pivot_table(index="client_rk", columns="order_type_cd", values="order_rk", aggfunc="count", fill_value=0)
for col in ["AIR", "HOT"]:
    if col not in client_types.columns: client_types[col] = 0
client_types["has_air"] = (client_types["AIR"] > 0)
client_types["has_hot"] = (client_types["HOT"] > 0)
both = int((client_types["has_air"] & client_types["has_hot"]).sum())
only_air = int((client_types["has_air"] & ~client_types["has_hot"]).sum())
only_hot = int((~client_types["has_air"] & client_types["has_hot"]).sum())
neither = int((~client_types["has_air"] & ~client_types["has_hot"]).sum())
figXS, axXS = plt.subplots(figsize=(8.5, 4.6))
axXS.bar(["–¢–æ–ª—å–∫–æ AIR", "–¢–æ–ª—å–∫–æ HOT", "–û–±–∞", "–ù–∏ —Ç–æ–≥–æ, –Ω–∏ –¥—Ä—É–≥–æ–≥–æ"], [only_air, only_hot, both, neither])
axXS.set_title("–ö—Ä–æ—Å—Å-—Å–µ–ª–ª: —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ —Ç–∏–ø–∞–º –ø–æ–∫—É–ø–æ–∫"); axXS.set_ylabel("–ö–ª–∏–µ–Ω—Ç–æ–≤")
for i, v in enumerate([only_air, only_hot, both, neither]): axXS.text(i, v + max(1, max([only_air, only_hot, both, neither]) * 0.01), f"{v:,}".replace(",", " "), ha="center", va="bottom")
pXS, sXS = savefig(figXS, "cross_sell_distribution")
cs_table = pd.DataFrame({
    "window_days": windows,
    "AIR‚ÜíHOT_%": [round(x*100, 2) if pd.notna(x) else np.nan for x in shares_air_to_hot],
    "HOT‚ÜíAIR_%": [round(x*100, 2) if pd.notna(x) else np.nan for x in shares_hot_to_air],
})
display(cs_table)

first_air = df.loc[df["order_type_cd"]=="AIR"].groupby("client_rk")["created_dttm"].min()
first_hot = df.loc[df["order_type_cd"]=="HOT"].groupby("client_rk")["created_dttm"].min()
delta_air_to_hot = (first_hot - first_air).dt.days
delta_hot_to_air = (first_air - first_hot).dt.days
windows = [3, 7, 14, 30]
def share_within(delta_series: pd.Series, window_days: int) -> float:
    mask_valid = delta_series.notna() & (delta_series >= 0)
    return float((delta_series[mask_valid] <= window_days).mean()) if mask_valid.sum() > 0 else np.nan
shares_air_to_hot = [share_within(delta_air_to_hot, w) for w in windows]
shares_hot_to_air = [share_within(delta_hot_to_air, w) for w in windows]
y1 = [x*100 if pd.notna(x) else 0 for x in shares_air_to_hot]
y2 = [x*100 if pd.notna(x) else 0 for x in shares_hot_to_air]
figXSp, axXSp = plt.subplots(figsize=(9, 4.8))
bars1 = axXSp.bar(np.arange(len(windows)) - 0.2, y1, width=0.4, label="AIR‚ÜíHOT")
bars2 = axXSp.bar(np.arange(len(windows)) + 0.2, y2, width=0.4, label="HOT‚ÜíAIR")
axXSp.set_title("–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –∫—Ä–æ—Å—Å-–ø–æ–∫—É–ø–∫–∏ –≤ –æ–∫–Ω–æ N –¥–Ω–µ–π –æ—Ç –ø–µ—Ä–≤–æ–π –ø–æ–∫—É–ø–∫–∏, %"); axXSp.set_xticks(np.arange(len(windows))); axXSp.set_xticklabels(windows)
axXSp.set_xlabel("–û–∫–Ω–æ (–¥–Ω–µ–π)"); axXSp.set_ylabel("% –∫–ª–∏–µ–Ω—Ç–æ–≤"); axXSp.legend()
for bars in (bars1, bars2):
    for b in bars: axXSp.text(b.get_x()+b.get_width()/2, b.get_height(), f"{b.get_height():.1f}%", ha="center", va="bottom", fontsize=9)
pXSp, sXSp = savefig(figXSp, "cross_sell_windowed_probs")
p_air_to_hot = share_within(delta_air_to_hot, 7); p_hot_to_air = share_within(delta_hot_to_air, 7)

#Simplified Funnel
funnel = (df.groupby(["order_type","lead_bucket"])["is_success"].agg(created="count", success="sum").reset_index())
funnel["suc_rate"] = funnel["success"] / funnel["created"]
figF, axF = plt.subplots(figsize=(10.5, 5.0))
for t, sub in funnel.groupby("order_type"):
    axF.plot(sub["lead_bucket"], sub["suc_rate"]*100, marker="o", label=t)
axF.set_title("–§–∞–Ω–Ω–µ–ª (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π): SUC-rate –ø–æ –∫–æ—Ä–∑–∏–Ω–∞–º lead-time"); axF.set_xlabel("–ö–æ—Ä–∑–∏–Ω–∞ lead-time"); axF.set_ylabel("SUC, %"); axF.legend(); plt.xticks(rotation=0)
pF, sF = savefig(figF, "funnel_by_lead")

#Activity Metrics
df["date"] = df["created_dttm"].dt.date; df["week"] = df["created_dttm"].dt.to_period("W"); df["month"] = df["created_dttm"].dt.to_period("M")
DAU = df.groupby("date")["client_rk"].nunique(); WAU = df.groupby("week")["client_rk"].nunique(); MAU = df.groupby("month")["client_rk"].nunique()
stickiness = (DAU.groupby(pd.to_datetime(DAU.index).to_period("M")).mean() / MAU).fillna(0)
x_d, x_w, x_m, x_sm = pd.to_datetime(DAU.index), WAU.index.to_timestamp(), MAU.index.to_timestamp(), stickiness.index.to_timestamp()
figAct, axAct = plt.subplots(2, 1, figsize=(14, 8))
axAct[0].plot(x_d, DAU.values, label="DAU"); axAct[0].plot(x_w, WAU.values, label="WAU"); axAct[0].plot(x_m, MAU.values, label="MAU")
axAct[0].set_title("DAU / WAU / MAU ‚Äî –¥–∏–Ω–∞–º–∏–∫–∞"); axAct[0].set_ylabel("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã"); axAct[0].legend()
axAct[1].bar(x_sm, stickiness.values, width=20, align="center")
axAct[1].set_title("Stickiness (—Å—Ä–µ–¥–Ω–∏–π DAU –≤ –º–µ—Å—è—Ü–µ / MAU)"); axAct[1].set_ylabel("–î–æ–ª—è"); axAct[1].yaxis.set_major_formatter(matplotlib.ticker.FuncFormatter(lambda v,_: f"{v:.0%}"))
for ax in axAct: ax.xaxis.set_major_formatter(mdates.ConciseDateFormatter(ax.xaxis.get_major_locator()))
figAct.autofmt_xdate(rotation=30)
savefig(figAct, "activity_metrics")

#ARPU & ARPPU
total_clients = df["client_rk"].nunique()
total_revenue = df["nominal_price_rub_amt"].sum()
paying_clients = df[df["nominal_price_rub_amt"] > 0]["client_rk"].nunique()
ARPU = (total_revenue / total_clients) if total_clients else 0
ARPPU = (total_revenue / paying_clients) if paying_clients else 0
print(f"üí° ARPU (–≤—ã—Ä—É—á–∫–∞/–∫–ª–∏–µ–Ω—Ç): {_fmt_int(ARPU)} ‚ÇΩ")
print(f"üí° ARPPU (–≤—ã—Ä—É—á–∫–∞/–ø–ª–∞—Ç—è—â–µ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞): {_fmt_int(ARPPU)} ‚ÇΩ")
w = 7
p_air_to_hot_7 = shares_air_to_hot[windows.index(w)]
p_hot_to_air_7 = shares_hot_to_air[windows.index(w)]
print(f"[–ö—Ä–æ—Å—Å-—Å–µ–ª–ª –∑–∞ {w} –¥–Ω–µ–π] AIR‚ÜíHOT ‚âà {p_air_to_hot_7*100:.1f}% | HOT‚ÜíAIR ‚âà {p_hot_to_air_7*100:.1f}%")

"""–ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –±–µ—Å–ø–æ–ª–µ–∑–µ–Ω –±–µ–∑ –≤—ã–≤–æ–¥–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π. –≠—Ç–æ—Ç –±–ª–æ–∫ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ —è–∑—ã–∫ –±–∏–∑–Ω–µ—Å–∞.
–ó–¥–µ—Å—å –º—ã:
1. –§–æ—Ä–º—É–ª–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç–æ–≤—ã–µ –≥–∏–ø–æ—Ç–µ–∑—ã: –ù–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∏–Ω—Å–∞–π—Ç–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ –æ—Ç —Ü–µ–Ω—ã) –º—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∏–¥–µ–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –ø—Ä–æ–¥—É–∫—Ç–∞.
2. –í—ã–±–∏—Ä–∞–µ–º –ª—É—á—à—É—é –≥–∏–ø–æ—Ç–µ–∑—É: –û–±–æ—Å–Ω–æ–≤—ã–≤–∞–µ–º, –∫–∞–∫—É—é –∏–∑ –∏–¥–µ–π —Å—Ç–æ–∏—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å –∏ –ø–æ—á–µ–º—É.
3. –†–∞–∑—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –º–µ—Ç–æ–¥–∏–∫—É: –û–ø–∏—Å—ã–≤–∞–µ–º, –∫–∞–∫ –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –æ—Ü–µ–Ω–∏—Ç—å –¥–æ–ª—é —Å–µ—Ä–≤–∏—Å–∞ –Ω–∞ —Ä—ã–Ω–∫–µ, –∏—Å–ø–æ–ª—å–∑—É—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∏ –≤–Ω–µ—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ. –≠—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Ö–æ–¥ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.
"""

#Hypotheses
hypotheses = [
    "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–º–æ-–∫–æ–¥—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —Å –∫–æ—Ä–æ—Ç–∫–∏–º –ª–∏–¥-—Ç–∞–π–º–æ–º (‚â§3 –¥–Ω—è) ‚Üí —Ä–æ—Å—Ç –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ last-minute.",
    "–£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–ø–ª–∞—Ç—É –¥–æ one-click –¥–ª—è –ª–æ—è–ª—å–Ω—ã—Ö (bundle Pro/Premium, —É—á–∞—Å—Ç–Ω–∏–∫–∏ LP) ‚Üí —Ä–æ—Å—Ç SUC-rate, –º–µ–Ω—å—à–µ –¥—Ä–æ–ø–∞.",
    "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø–∞–∫–µ—Ç—ã ¬´–∞–≤–∏–∞–±–∏–ª–µ—Ç+–æ—Ç–µ–ª—å¬ª –≤ –ø–æ–∏—Å–∫–µ/–∫–æ—Ä–∑–∏–Ω–µ ‚Üí —Ä–æ—Å—Ç AOV –∏ –∫—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂."
]
best_hypothesis = hypotheses[2]
best_rationale = [
    "–í –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å —Å–æ–≤–º–µ—Å—Ç–Ω—ã–π —Å–ø—Ä–æ—Å: –¥–ª—è —á–∞—Å—Ç–∏ –ø–æ–µ–∑–¥–æ–∫ –ª–æ–≥–∏—á–Ω–æ –±—Ä–∞—Ç—å –∏ –ø–µ—Ä–µ–ª—ë—Ç, –∏ –æ—Ç–µ–ª—å.",
    "–ì–∏–ø–æ—Ç–µ–∑–∞ –¥–∞—ë—Ç –¥–≤–æ–π–Ω–æ–π —ç—Ñ—Ñ–µ–∫—Ç: ‚ÜëAOV + ‚Üë–∫—Ä–æ—Å—Å-–ø—Ä–æ–¥–∞–∂–∏, –∏–∑–º–µ—Ä—è–µ—Ç—Å—è –ø—Ä–æ—Å—Ç—ã–º A/B-—Ç–µ—Å—Ç–æ–º.",
    "–ú–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å –±–µ–∑ —Ç—è–∂—ë–ª–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏ (–ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–æ –¥–∞—Ç–∞–º/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º/—Ü–µ–Ω–µ).",
    "Primary metric: AOV; Secondary: % –ø–∞–∫–µ—Ç–æ–≤, CR –ø–æ–∏—Å–∫‚Üí–ø–æ–∫—É–ø–∫–∞, –æ—Ç–∫–∞–∑ –Ω–∞ –æ–ø–ª–∞—Ç–µ."
]

#Market Share
if "created_dttm" in df.columns:
    d24 = df[df["created_dttm"].dt.year == 2024]
    ms_air_suc = int(((d24["order_type_cd"]=="AIR") & (d24["is_success"])).sum())
    ms_hot_suc = int(((d24["order_type_cd"]=="HOT") & (d24["is_success"])).sum())
else:
    ms_air_suc = ms_hot_suc = 0

market_methodology_note = f"""
–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∏ —Å–µ—Ä–≤–∏—Å–∞ (—ç—Å–∫–∏–∑ –º–µ—Ç–æ–¥–∏–∫–∏):
  1) –ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–∏–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2024) –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤ –Ω–∞—à–µ–º –¥–∞—Ç–∞—Å–µ—Ç–µ:
     SUC_AIR={_fmt_int(ms_air_suc)}, SUC_HOT={_fmt_int(ms_hot_suc)}.
  2) –í–∑—è—Ç—å –≤–Ω–µ—à–Ω–∏–µ –∞–≥—Ä–µ–≥–∞—Ç—ã:
     Passengers_total (–†–æ—Å–∞–≤–∏–∞—Ü–∏—è), RoomNights_total (–†–æ—Å—Å—Ç–∞—Ç/–æ—Ç—Ä–∞—Å–ª–µ–≤—ã–µ –æ—Ç—á—ë—Ç—ã).
  3) –î–æ–ª–∏:
     –¥–æ–ª—è_–∞–≤–∏–∞ ‚âà SUC_AIR / Passengers_total,
     –¥–æ–ª—è_–æ—Ç–µ–ª–∏ ‚âà SUC_HOT / RoomNights_total.
  4) –ö–æ—Ä—Ä–µ–∫—Ü–∏–∏: –º—É–ª—å—Ç–∏—Å–µ–≥–º–µ–Ω—Ç–Ω—ã–µ –±–∏–ª–µ—Ç—ã, –æ—Ç–º–µ–Ω—ã/–≤–æ–∑–≤—Ä–∞—Ç—ã, —Ä–∞–∑–Ω–∏—Ü–∞ ¬´–ø–∞—Å—Å–∞–∂–∏—Ä vs –∑–∞–∫–∞–∑¬ª, —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç—å.
"""

"""–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω—É–∂–Ω–æ –∫—Ä–∞—Å–∏–≤–æ —É–ø–∞–∫–æ–≤–∞—Ç—å –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –∫–æ–ª–ª–µ–≥–∞–º. –≠—Ç–æ—Ç –±–ª–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö –æ—Ç—á–µ—Ç–æ–≤. –û–Ω –±–µ—Ä–µ—Ç –≤—Å–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ –≥—Ä–∞—Ñ–∏–∫–∏ –∏ –≤—ã–≤–æ–¥—ã –∏ —Å–æ–±–∏—Ä–∞–µ—Ç –∏–∑ –Ω–∏—Ö –¥–≤–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞:
1. HTML-–ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –≤–µ–±-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ —Å–ª–∞–π–¥–∞–º–∏, –≥—Ä–∞—Ñ–∏–∫–∞–º–∏ –∏ –∫–ª—é—á–µ–≤—ã–º–∏ –≤—ã–≤–æ–¥–∞–º–∏. –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä—è–º–æ –≤ —Ñ–∞–π–ª, –ø–æ—ç—Ç–æ–º—É –µ–≥–æ –ª–µ–≥–∫–æ –ø–µ—Ä–µ—Å—ã–ª–∞—Ç—å.
2. Jupyter-–Ω–æ—É—Ç–±—É–∫ (.ipynb): –°–æ–∑–¥–∞–µ—Ç—Å—è —Ñ–∞–π–ª –Ω–æ—É—Ç–±—É–∫–∞, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–µ—Å—å –∫–æ–¥ –∞–Ω–∞–ª–∏–∑–∞. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç—å –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è ‚Äî –ª—é–±–æ–π –¥—Ä—É–≥–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫ —Å–º–æ–∂–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –≤—Å–µ —à–∞–≥–∏.
"""

#HTML Presentation
from pathlib import Path

TBRAND = {
    "bg": "#F5F6F8",
    "slide": "#FFFFFF",
    "text": "#111111",
    "muted": "#6B7280",
    "border": "#EAECEF",
    "yellow": "#FFDD2D",
    "yellowDark": "#E6C200",
    "shadow": "0 14px 40px rgba(17,17,17,.10)",
    "ok": "#10B981", "warn": "#F59E0B", "bad": "#EF4444",
}

WEBFONTS = """
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@500;700;800&family=Inter:wght@400;600&display=swap" rel="stylesheet">
"""

def _build_css(C=TBRAND):
    return f"""
*{{box-sizing:border-box}} html,body{{height:100%}}
body{{margin:0;background:{C['bg']};color:{C['text']};font-family:Manrope,Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}}

.slide{{width:1280px;height:720px;margin:24px auto;padding:54px 60px 50px;background:{C['slide']};
  border:1px solid {C['border']};border-radius:24px;box-shadow:{C['shadow']};position:relative;overflow:hidden}}
.slide.has-brand{{padding-top:120px}}
.brand-bar{{position:absolute;left:0;top:0;right:0;height:72px;background:{C['yellow']};border-bottom:1px solid rgba(0,0,0,.06)}}

.brand-corner{{position:absolute;right:-120px;bottom:-120px;width:340px;height:340px;border-radius:50%;
  background:radial-gradient(closest-side,rgba(255,221,45,.22),transparent 70%)}}

h1.title{{margin:0;font-size:44px;line-height:1.12;font-weight:800;letter-spacing:.1px}}
.subtitle{{margin-top:10px;color:{C['muted']};font-size:18px}}
.title-underline{{width:72px;height:6px;background:{C['yellow']};border-radius:3px;margin:12px 0 8px}}

.hr{{height:2px;background:{C['border']};margin:16px 0 18px}}

.grid{{display:grid;gap:16px}}
.grid.two{{grid-template-columns:1fr 1fr}}
.grid.three{{grid-template-columns:1fr 1fr 1fr}}
.grid.four{{grid-template-columns:1fr 1fr 1fr 1fr}}

.card{{background:#fff;border:1px solid {C['border']};border-radius:16px;padding:14px;min-height:140px;box-shadow:0 6px 24px rgba(17,17,17,.06)}}
.card h3{{margin:0 0 8px;font-size:18px;font-weight:700}}
.card p.caption{{margin:6px 0 0;color:{C['muted']};font-size:14px}}
.card img{{width:100%;height:360px;object-fit:contain;background:#FAFBFC;border-radius:12px;border:1px solid {C['border']}}}

.kpi-row{{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}}
.kpi{{flex:1 1 0;min-width:220px;background:#fff;border:1px solid {C['border']};border-radius:16px;padding:12px 14px;box-shadow:0 6px 24px rgba(17,17,17,.06)}}
.kpi .label{{color:{C['muted']};font-size:13px;margin-bottom:4px}}
.kpi .value{{font-size:28px;font-weight:800;letter-spacing:.2px}}
.kpi.ok .value{{color:{C['ok']}}} .kpi.warn .value{{color:{C['warn']}}} .kpi.bad .value{{color:{C['bad']}}}

.chips{{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 4px}}
.chip{{background:{C['yellow']};border:1px solid rgba(0,0,0,.06);border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}}
.note{{background:#FFFBEA;border:1px solid {C['yellowDark']};border-left:6px solid {C['yellowDark']};border-radius:12px;padding:12px 14px;color:{C['text']};font-size:14px}}

ul.bullets{{padding-left:18px;margin:8px 0 0}}
ul.bullets li{{margin:6px 0;color:{C['text']}}}
ul.bullets li::marker{{color:{C['yellowDark']}}}

.table{{width:100%;border-collapse:collapse;margin-top:8px}}
.table th,.table td{{border:1px solid {C['border']};padding:8px 10px;text-align:left}}
.table th{{background:#FAFBFC}}
.table .r{{text-align:right}}

.footer{{position:absolute;left:0;right:0;bottom:16px;display:flex;justify-content:space-between;padding:0 24px;color:{C['muted']};font-size:12.5px}}
.footer .brand{{font-weight:700}}

@media print{{@page{{size:1280px 720px;margin:0}} .slide{{page-break-after:always;box-shadow:none;margin:0 auto}}}}
"""

def _esc(s):
    return "" if s is None else str(s).replace("&","&amp;").replace("<","&lt;").replace(">","&gt;")

def card_img(img_path, caption=""):
    return f"""<div class="card"><img src="{_esc(img_path)}" alt="{_esc(caption)}"/><p class="caption">{_esc(caption)}</p></div>"""

def _bullets(items):
    if not items: return ""
    return "<ul class='bullets'>" + "\n".join(f"<li>{_esc(x)}</li>" for x in items) + "</ul>"

def html_cover(title, subtitle="", badge="–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å–∫–∞"):
    return f"""
<section class="slide has-brand">
  <div class="brand-bar"></div>
  <div style="position:absolute; right:26px; top:18px;" class="chip">{_esc(badge)}</div>
  <h1 class="title">{_esc(title)}</h1>
  <div class="subtitle">{_esc(subtitle)}</div>
  <div class="brand-corner"></div>
  <div class="footer"><span class="brand">T-Bank ¬∑ Product Analytics</span><span>Cover</span></div>
</section>"""

def html_kpis(title, kpis, bullets=None, subtitle="", chips=None):
    kpi_html = "".join([
        f"""<div class="kpi {'ok' if k.get('tone')=='ok' else 'warn' if k.get('tone')=='warn' else 'bad' if k.get('tone')=='bad' else ''}">
              <div class="label">{_esc(k.get('label',''))}</div>
              <div class="value">{_esc(k.get('value',''))}</div>
            </div>""" for k in kpis
    ])
    chips_html = "" if not chips else "<div class='chips'>" + "".join(f"<span class='chip'>{_esc(c)}</span>" for c in chips) + "</div>"
    return f"""
<section class="slide">
  <div class="title-underline"></div><h1 class="title">{_esc(title)}</h1>
  {f'<div class="subtitle">{_esc(subtitle)}</div>' if subtitle else ''}{chips_html}
  <div class="kpi-row">{kpi_html}</div>{_bullets(bullets)}
  <div class="footer"><span class="brand">T-Bank</span><span>KPIs</span></div>
</section>"""

def html_section(title, bullets=None, note=None, subtitle="", cols=2, cards=None, chips=None):
    grid_class = "two" if cols==2 else "three" if cols==3 else "four"
    chips_html = "" if not chips else "<div class='chips'>" + "".join(f"<span class='chip'>{_esc(c)}</span>" for c in chips) + "</div>"
    cards_html = "".join(cards or [])
    return f"""
<section class="slide">
  <div class="title-underline"></div><h1 class="title">{_esc(title)}</h1>
  {f'<div class="subtitle">{_esc(subtitle)}</div>' if subtitle else ''}{chips_html}
  {_bullets(bullets)}
  {'<div class="note">'+_esc(note)+'</div>' if note else ''}
  <div class="hr"></div>
  <div class="grid {grid_class}">{cards_html}</div>
  <div class="footer"><span class="brand">T-Bank</span><span>{_esc(title[:24])}</span></div>
</section>"""

def html_slide(title, bullets=None, grid_imgs=None, subtitle="", chips=None):
    return html_section(title, bullets=bullets, subtitle=subtitle, cols=2, cards=grid_imgs, chips=chips)

def html_compact_hypotheses(hyp_list, best_title, best_points, share_rows):
    """
    hyp_list: [str, str, str]
    best_title: str
    best_points: [str, str, ...]
    share_rows: list of rows for table: [(label, our, market, share), ...]
    """
    table_rows = "".join([
        f"<tr><td>{_esc(lbl)}</td><td class='r'>{_esc(our)}</td><td class='r'>{_esc(mkt)}</td><td class='r'>{_esc(sh)}</td></tr>"
        for (lbl, our, mkt, sh) in share_rows
    ])
    return f"""
<section class="slide">
  <div class="title-underline"></div><h1 class="title">–ì–∏–ø–æ—Ç–µ–∑—ã ‚Üí –õ—É—á—à–∞—è ‚Üí –î–æ–ª—è —Å–µ—Ä–≤–∏—Å–∞</h1>
  <div class="grid three">
    <div class="card">
      <h3>–ì–∏–ø–æ—Ç–µ–∑—ã –¥–ª—è A/B</h3>
      {_bullets(hyp_list)}
      <p class="caption">–ú–µ—Ç—Ä–∏–∫–∏: CR cross-sell, ARPU, LTV 60‚Äì90–¥</p>
    </div>
    <div class="card">
      <h3>{_esc(best_title)}</h3>
      {_bullets(best_points)}
      <div class="note">–û–∂–∏–¥–∞–µ–º—ã–π —ç—Ñ—Ñ–µ–∫—Ç: +CR cross-sell 1.3‚Äì1.8√ó; –≤—Ç–æ—Ä–∏—á–Ω–æ ‚Äî —Ä–æ—Å—Ç —É–¥–µ—Ä–∂–∞–Ω–∏—è</div>
    </div>
    <div class="card">
      <h3>–û—Ü–µ–Ω–∫–∞ –¥–æ–ª–∏ —Å–µ—Ä–≤–∏—Å–∞ (—á–µ—Ä–Ω–æ–≤–∞—è)</h3>
      <table class="table">
        <thead><tr><th>–°–µ–≥–º–µ–Ω—Ç</th><th class='r'>–ù–∞—à–∏ —É—Å–ø–µ—Ö–∏</th><th class='r'>–†—ã–Ω–æ–∫</th><th class='r'>–î–æ–ª—è</th></tr></thead>
        <tbody>{table_rows}</tbody>
      </table>
      <p class="caption">–î–æ–ø—É—â–µ–Ω–∏–µ: 1 –∑–∞–∫–∞–∑ ‚âà 1 –ø–∞—Å—Å–∞–∂–∏—Ä/1 –ø—Ä–æ–∂–∏–≤–∞–Ω–∏–µ</p>
    </div>
  </div>
  <div class="footer"><span class="brand">T-Bank</span><span>Summary</span></div>
</section>"""

def build_html_document(doc_title, slides):
    css = _build_css()
    head = f"""<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>{_esc(doc_title)}</title>
{WEBFONTS}<style>{css}</style></head><body>"""
    foot = "</body></html>"
    return head + "\n".join(slides) + foot

def save_presentation(slides, title="T-Bank ¬∑ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å–∫–∞", out_path="tbank_report.html"):
    out = Path(out_path)
    out.write_text(build_html_document(title, slides), encoding="utf-8")
    print(f"[saved] {out.resolve()}")
    return str(out.resolve())

try: slides_html
except NameError: slides_html = []

slides_html.append(html_cover(
    title="–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è T-Bank: EDA, –≥–∏–ø–æ—Ç–µ–∑—ã, –¥–æ–ª—è —Å–µ—Ä–≤–∏—Å–∞",
    subtitle="–û—Ç–µ–ª–∏ –∏ –∞–≤–∏–∞–±–∏–ª–µ—Ç—ã ¬∑ –∫–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑, RFM, –∫—Ä–æ—Å—Å-—Å–µ–ª–ª, SUC-rate",
    badge="–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å–∫–∞"
))

suc_air = float(df.loc[df["order_type_cd"] == "AIR", "is_success"].mean() * 100)
suc_hot = float(df.loc[df["order_type_cd"] == "HOT", "is_success"].mean() * 100)

avg_check = float(df["nominal_price_rub_amt"].mean())

mau = int(df["month"].dropna().groupby(df["month"]).apply(lambda s: df.loc[s.index, "client_rk"].nunique()).iloc[-1]) \
      if "month" in df.columns and len(df["month"].dropna()) else 0

try:
    mau = int(MAU.iloc[-1])
except Exception:
    pass

try:
    stickiness_last = float(stickiness.iloc[-1])
except Exception:
    last_m = df["created_dttm"].dt.to_period("M").max()
    dau_last_month = (df.loc[df["created_dttm"].dt.to_period("M") == last_m]
                        .groupby(df["created_dttm"].dt.date)["client_rk"].nunique()).mean()
    stickiness_last = (dau_last_month / mau) if mau else 0.0

orders_by_month = df["created_dttm"].dt.to_period("M").value_counts().sort_index()
season_peak = str(orders_by_month.idxmax()) if len(orders_by_month) else "‚Äî"

revenue_per_user = df.groupby("client_rk")["nominal_price_rub_amt"].sum().sort_values(ascending=False)
if len(revenue_per_user):
    cum = revenue_per_user.cumsum() / revenue_per_user.sum()
    core_share = float((cum < 0.72).mean())
    core_rev_target = 0.72
else:
    core_share, core_rev_target = 0.0, 0.0

tone_air = "ok" if suc_air >= 25 else "warn"
tone_hot = "ok" if suc_hot >= 25 else "warn"

slides_html.append(html_kpis(
    title="–°–≤–æ–¥–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏",
    subtitle=f"–ü–µ—Ä–∏–æ–¥: {period[0]} ‚Äî {period[1]}",
    kpis=[
        {"label": "SUC-rate (AIR)", "value": f"{suc_air:.1f}%", "tone": tone_air},
        {"label": "SUC-rate (HOT)", "value": f"{suc_hot:.1f}%", "tone": tone_hot},
        {"label": "–°—Ä–µ–¥–Ω–∏–π —á–µ–∫, ‚ÇΩ",  "value": f"{avg_check:,.0f}".replace(",", " ")},
        {"label": "MAU / Stickiness", "value": f"{mau:,}".replace(",", " ") + f" / {stickiness_last:.1%}"}
    ],
    bullets=[
        f"–ü–∏–∫ —Å–µ–∑–æ–Ω–∞: {season_peak}",
        "Lead-time > 21 –¥–Ω–µ–π ‚Üí —Ä–æ—Å—Ç SUC (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ AIR)",
        f"RFM: —è–¥—Ä–æ ‚âà {core_share:.1%} –∫–ª–∏–µ–Ω—Ç–æ–≤ ‚Üí ~{int(core_rev_target*100)}% –≤—ã—Ä—É—á–∫–∏"
    ],
    chips=["AIR", "HOT", str(pd.to_datetime(df['created_dttm'].min()).year) if df['created_dttm'].notna().any() else ""]
))


slides_html.append(html_slide("–ö–æ–≥–æ—Ä—Ç–Ω—ã–π –∞–Ω–∞–ª–∏–∑", grid_imgs=[card_img(pR,"Retention –∫–æ–≥–æ—Ä—Ç"), card_img(pL,"LTV-–∫—Ä–∏–≤—ã–µ")]))
slides_html.append(html_slide("RFM-—Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è", grid_imgs=[card_img(pRFM1,"–¢–æ–ø —Å–µ–≥–º–µ–Ω—Ç—ã"), card_img(pRFM2,"F√óM, —Ü–≤–µ—Ç=R")]))
slides_html.append(html_slide("–ö—Ä–æ—Å—Å-—Å–µ–ª–ª AIR‚ÜîHOT", grid_imgs=[card_img(pXS,"–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤"), card_img(pXSp,"–û–∫–Ω–∞ 3/7/14/30 –¥–Ω–µ–π")]))

MARKET_AIR_2024 = 111_700_000
MARKET_HOT_2024 = 390_200_000


d24 = df[df["created_dttm"].dt.year == 2024] if df["created_dttm"].notna().any() else df.iloc[0:0]
air_suc_24 = int(((d24["order_type_cd"] == "AIR") & (d24["is_success"])).sum())
hot_suc_24 = int(((d24["order_type_cd"] == "HOT") & (d24["is_success"])).sum())

air_share = (air_suc_24 / MARKET_AIR_2024) if MARKET_AIR_2024 else None
hot_share = (hot_suc_24 / MARKET_HOT_2024) if MARKET_HOT_2024 else None

share_rows = [
    ("–ê–≤–∏–∞",  _fmt_int(air_suc_24),
              _fmt_int(MARKET_AIR_2024) if MARKET_AIR_2024 else "‚Äî",
              _fmt_pct(air_share) if air_share is not None else "‚Äî"),
    ("–û—Ç–µ–ª–∏", _fmt_int(hot_suc_24),
              _fmt_int(MARKET_HOT_2024) if MARKET_HOT_2024 else "‚Äî",
              _fmt_pct(hot_share) if hot_share is not None else "‚Äî"),
]

slides_html.append(html_compact_hypotheses(
    hyp_list=[
        "–ë–∞–Ω–¥–ª ¬´–ø–µ—Ä–µ–ª—ë—Ç+–æ—Ç–µ–ª—å¬ª —Å–æ —Å–∫–∏–¥–∫–æ–π 5‚Äì7% ‚Üë cross-sell (AIR‚ÜíHOT)",
        "–°–º–∞—Ä—Ç-—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ lead-time (—Ä–∞–Ω–Ω–∏–µ ‚Äî –≥–∏–±–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã)",
        "RFM-–ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è: —è–¥—Ä—É ‚Äî –ø—Ä–µ–º–∏—É–º –ø–∞–∫–µ—Ç—ã; –Ω–æ–≤–∏—á–∫–∞–º ‚Äî –∫—ç—à–±—ç–∫"
    ],
    best_title="–ü–æ—á–µ–º—É –±–∞–Ω–¥–ª ¬´–ø–µ—Ä–µ–ª—ë—Ç+–æ—Ç–µ–ª—å¬ª ‚Äî ‚Ññ1",
    best_points=[
        "–í –¥–∞–Ω–Ω—ã—Ö –µ—Å—Ç—å –∫—Ä–æ—Å—Å-–ø–µ—Ä–µ—Ö–æ–¥—ã –≤ –æ–∫–Ω–∞—Ö 7‚Äì14 –¥–Ω–µ–π",
        "–ï–¥–∏–Ω–∞—è –∫–æ—Ä–∑–∏–Ω–∞/—á–µ–∫ ‚Üì —Ñ—Ä–∏–∫—Ü–∏—é ‚Üí ‚Üë CR –∏ AOV",
        "A/B: —Å–∫–∏–¥–∫–∞ 5/7/10%, —Ç—Ä–∏–≥–≥–µ—Ä ‚â§ 48 —á, —Ç–∞—Ä–≥–µ—Ç –ø–æ RFM"
    ],
    share_rows=share_rows
))
out_html = save_presentation(slides_html,
                             title="T-Bank ¬∑ –ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–ø–∏—Å–∫–∞",
                             out_path="tbank_report.html")
print("–ì–æ—Ç–æ–≤–æ:", out_html)

#Jupyter Notebook
nb_cells = [
    new_markdown_cell("# –¢-–ë–∞–Ω–∫: –æ—Ç–µ–ª–∏ –∏ –∞–≤–∏–∞–±–∏–ª–µ—Ç—ã ‚Äî EDA\n"
                      f"**–§–∞–π–ª:** `{CFG.csv_path}` **–ü–µ—Ä–∏–æ–¥:** {period[0]} ‚Äî {period[1]}"),
    new_code_cell(textwrap.dedent(f"""
        import pandas as pd, numpy as np, matplotlib.pyplot as plt
        {'import seaborn as sns; sns.set_theme(context="notebook", style="ticks")' if _HAS_SEABORN else ''}
        df = pd.read_csv("{CFG.csv_path}", sep="{CFG.sep}", encoding="{CFG.encoding}", low_memory=False)


        DATE_COLS = {DATE_COLS}
        for c in DATE_COLS:
            if c in df.columns: df[c] = pd.to_datetime(df[c], errors="coerce")

        NUM_COLS = {NUM_COLS}
        def coerce_numeric(s):
            return pd.to_numeric(s.astype(str).str.replace(" ","").str.replace("\\xa0","").str.replace(",", "."),
                                 errors="coerce")
        for c in NUM_COLS:
            if c in df.columns: df[c] = coerce_numeric(df[c])


        FLAG_COLS = [c for c in df.columns if c.endswith("_flg")]
        for c in FLAG_COLS:
            df[c] = pd.to_numeric(df[c].astype(str).str.replace(",", "."), errors="coerce")
            df[c] = (df[c].fillna(0) > 0)


        df["order_type"] = df.get("order_type_cd").map({{"AIR":"–ê–≤–∏–∞–±–∏–ª–µ—Ç—ã","HOT":"–û—Ç–µ–ª–∏"}}).fillna(df.get("order_type_cd"))
        df["is_success"] = df.get("order_status_cd","").eq("SUC")
        df["order_month"] = df["created_dttm"].dt.to_period("M").astype(str)


        df["lead_time_days"] = (df["book_start_dttm"] - df["created_dttm"]).dt.days if "book_start_dttm" in df.columns else np.nan
        if "book_end_dttm" in df.columns and "book_start_dttm" in df.columns:
            df["stay_nights"] = (df["book_end_dttm"] - df["book_start_dttm"]).dt.days
            df.loc[df.get("order_type_cd")!="HOT", "stay_nights"] = np.nan

        df.info()
    """)),
    new_markdown_cell("## –°–≤–æ–¥–∫–∞ –∏ –≥—Ä–∞—Ñ–∏–∫–∏"),
    new_code_cell('df.groupby("order_type").agg(orders=("order_rk","count"), success_rate=("is_success","mean"), avg_price_rub=("nominal_price_rub_amt","mean"))'),
    new_code_cell('df.groupby(["order_month","order_type"])["order_rk"].count().unstack(fill_value=0).plot(marker="o"); plt.title("–î–∏–Ω–∞–º–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ –º–µ—Å—è—Ü–∞–º"); plt.xticks(rotation=45); plt.tight_layout()'),
    new_code_cell('(df.groupby("order_type")["is_success"].mean()*100).plot(kind="bar"); plt.title("SUC-rate, %"); plt.tight_layout()'),
    new_markdown_cell("## –ì–∏–ø–æ—Ç–µ–∑—ã\n" + "\n".join([f"- {h}" for h in hypotheses]) + "\n\n**–í—ã–±–æ—Ä:** " + best_hypothesis)
]
nb = new_notebook(cells=nb_cells, metadata={"language_info":{"name":"python","version":sys.version.split()[0]}})
with open(CFG.ipynb_path, "w", encoding="utf-8") as f: nbf.write(nb, f)
print(f"[saved] ipynb ‚Üí {CFG.ipynb_path.resolve()}")

"""–§–∏–Ω–∞–ª—å–Ω—ã–π –∏ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –±–ª–æ–∫. –ï–≥–æ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–æ–±—â–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª —Å–≤–æ—é —Ä–∞–±–æ—Ç—É. –û–Ω –≤—ã–≤–æ–¥–∏—Ç –≤ –∫–æ–Ω—Å–æ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏, —á—Ç–æ —Å–∞–º–æ–µ –≤–∞–∂–Ω–æ–µ, –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏ –∫ —Å–æ–∑–¥–∞–Ω–Ω—ã–º —Ñ–∞–π–ª–∞–º (HTML-–æ—Ç—á–µ—Ç—É –∏ Jupyter-–Ω–æ—É—Ç–±—É–∫—É), —á—Ç–æ–±—ã –∏—Ö –º–æ–∂–Ω–æ –±—ã–ª–æ –ª–µ–≥–∫–æ –Ω–∞–π—Ç–∏ –∏ –æ—Ç–∫—Ä—ã—Ç—å."""

print("\n=== –ì–æ—Ç–æ–≤–æ ===")
print("–ü–∞–ø–∫–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏:", CFG.out_dir.resolve())
print("–°–ª–∞–π–¥—ã (HTML):", CFG.html_path.resolve())
print("–ù–æ—É—Ç–±—É–∫ (.ipynb):", CFG.ipynb_path.resolve())